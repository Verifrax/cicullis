name: Attestor

on:
  workflow_run:
    workflows: ["Gates"]
    types: [completed]

permissions:
  contents: read
  statuses: write
  pull-requests: read

concurrency:
  group: attestor-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  attest:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR head SHA
        id: ctx
        env:
          REPO: ${{ github.event.workflow_run.repository.full_name }}
        run: |
          set -euo pipefail
          sha="$(jq -r '.workflow_run.pull_requests[0].head.sha // empty' "$GITHUB_EVENT_PATH")"

          if [ -z "$sha" ]; then
            echo "has_pr=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_pr=true" >> "$GITHUB_OUTPUT"
          echo "repo=$REPO"  >> "$GITHUB_OUTPUT"
          echo "sha=$sha"    >> "$GITHUB_OUTPUT"

      - name: Verify upstream required statuses
        if: ${{ steps.ctx.outputs.has_pr == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ steps.ctx.outputs.repo }}
          SHA:  ${{ steps.ctx.outputs.sha }}
        run: |
          set -euo pipefail

          required=(
            "Gates / cicullis (pull_request)"
            "Gates / hygiene (pull_request)"
            "Gates / selftest (pull_request)"
          )

          for ctx in "${required[@]}"; do
            state="$(gh api "repos/$REPO/commits/$SHA/status" \
              -H "Accept: application/vnd.github+json" \
              --jq --arg c "$ctx" '.statuses[]? | select(.context==$c) | .state' | head -n1)"

            [ "$state" = "success" ] || exit 1
          done

      - name: Publish verifrax-attestor
        if: ${{ steps.ctx.outputs.has_pr == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ steps.ctx.outputs.repo }}
          SHA:  ${{ steps.ctx.outputs.sha }}
        run: |
          gh api -X POST "repos/$REPO/statuses/$SHA" \
            -H "Accept: application/vnd.github+json" \
            -f state=success \
            -f context="verifrax-attestor" \
            -f description="Attestor: upstream contexts verified" \
            -f target_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
